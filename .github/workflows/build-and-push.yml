name: Build and Push with Buildx Cache

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ§± Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: â±ï¸ Print start time
      run: echo "Build started at: $(date)"

    - name: ğŸ³ Build and push with cache (timed)
      run: |
        echo "Starting timed build..."
        time docker buildx build \
          --file Dockerfile \
          --tag cath0806/myapp:buildx \
          --cache-from=type=registry,ref=cath0806/myapp:buildx \
          --cache-to=type=inline \
          --push \
          .

    - name: â±ï¸ Print end time
      run: echo "Build ended at: $(date)"
